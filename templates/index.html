<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEMS - Business Expense Management System</title>
    <meta name="description" content="Database Management System for Business Expenses">

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Column resizing functionality
            const thElements = document.querySelectorAll('th');
            let isResizing = false;
            let currentTh = null;
            let startX = 0;
            let startWidth = 0;

            thElements.forEach(th => {
                // Add resize indicator div
                const resizeIndicator = document.createElement('div');
                resizeIndicator.className = 'resize-indicator';
                th.appendChild(resizeIndicator);

                th.addEventListener('mousedown', function(e) {
                    // Check if we're clicking on the resize handle
                    if (e.offsetX > this.offsetWidth - 10) {
                        isResizing = true;
                        currentTh = this;
                        startX = e.pageX;
                        startWidth = this.offsetWidth;
                        document.body.classList.add('resizing');
                        e.preventDefault();
                    }
                });
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const width = startWidth + (e.pageX - startX);
                if (width > 50) { // Minimum width
                    currentTh.style.width = width + 'px';
                    currentTh.style.minWidth = width + 'px';
                }
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
                currentTh = null;
                document.body.classList.remove('resizing');
            });

            // Table sorting functionality
            const sortableHeaders = document.querySelectorAll('th.sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const table = this.closest('table');
                    const columnIndex = Array.from(this.parentElement.children).indexOf(this);
                    const isAsc = this.classList.contains('sort-asc');
                    
                    // Reset all sort indicators
                    sortableHeaders.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    // Set new sort direction
                    this.classList.remove(isAsc ? 'sort-asc' : 'sort-desc');
                    this.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
                    
                    // Here you would typically:
                    // 1. Send an AJAX request to your backend with the sort parameters
                    // 2. Update the table with the sorted data
                    // For now, we'll just log the action
                    console.log(`Sorting by column ${columnIndex} in ${isAsc ? 'descending' : 'ascending'} order`);
                });
            });

            // Form submission handling
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
                    }
                });
            });

            // History state management
            if (window.history.replaceState) {
                window.history.replaceState(null, null, "/");
            }
        });

        function confirmDelete(id) {
            return confirm(`Are you sure you want to delete record ${id}?`);
        }
    </script>
</head>

<body>
    <header>
        <nav>
            <div class="nav-logo">
                <span class="material-symbols-outlined">database</span>
                <span>Biz<span>Exp</span></span>
            </div>
            <div class="nav-links">
                <a href="/" class="active">Dashboard</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">
                        <span class="material-symbols-outlined">
                            {% if category == 'success' %}check_circle{% elif category == 'error' %}error{% else %}info{% endif %}
                        </span>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card">
            <h2>Database Management</h2>
            <form method="POST" action="/">
                <div class="select-container">
                    <label for="table-select">Select Table</label>
                    <select name="table_select" id="table-select" class="table-selector" onchange="this.form.submit()">
                        {% for table in tables %}
                            <option value="{{ table }}" {% if table == selected_table %}selected{% endif %}>
                                {{ table | replace('_', ' ') | title }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            <form method="POST" action="/add">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                {% for column in columns %}
                                    <th class="{% if column != 'actions' %}sortable{% endif %}">
                                        {{ column | replace('_', ' ') | title }}
                                    </th>
                                {% endfor %}
                                <th>Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                            <!-- Display existing rows -->
                            {% for row in rows %}
                                <tr>
                                    {% for col in columns %}
                                        <td>{{ row[loop.index0] }}</td>
                                    {% endfor %}
                                    <td class="flex gap-1">
                                        <button type="button" class="btn secondary" title="Edit">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button type="button" class="btn danger" title="Delete" onclick="return confirmDelete('{{ row[0] }}')">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            
                            <!-- Add new record row -->
                            <tr class="add-row">
                                {% for column in columns %}
                                    <td>
                                        {% if column in auto_inc_fields %}
                                            <input type="text" name="{{ column }}" value="Auto" disabled>
                                        {% elif column in enum_fields %}
                                            <select name="{{ column }}">
                                                {% for val in enum_fields[column] %}
                                                    <option value="{{ val }}">{{ val | replace('_', ' ') | title }}</option>
                                                {% endfor %}
                                            </select>
                                        {% else %}
                                            <input type="text" name="{{ column }}" placeholder="Enter {{ column | replace('_', ' ') | lower }}" required>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td>
                                    <button type="submit" class="flex items-center">
                                        <span class="material-symbols-outlined">add</span>
                                        Add
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </main>

    <!-- Floating Action Button -->
    <button class='fab' title='Add New Record' onclick='document.querySelector("form[action=\"/add\"]").scrollIntoView({ behavior: "smooth" })'>
        <span class="material-symbols-outlined">add</span>
    </button>
</body>
</html>